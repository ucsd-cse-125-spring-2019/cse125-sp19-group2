/**
 * Application.hpp
 */

#include "Application.hpp"
#include <iostream>

Application::Application(const char *windowTitle, int argc, char **argv)
{
	_win_title  = windowTitle;
	_win_width  = 800;
	_win_height = 600;

	if (argc == 1)
	{
	}
	else
	{
		std::cerr << "Invalid number of arguments" << std::endl;
		return;
	}

	// Initialize GLFW
	if (!glfwInit())
	{
		std::cerr << "Failed to initialize GLFW\n" << std::endl;
		return;
	}

	glfwSetErrorCallback(StaticError);
}

Application::~Application()
{
	if (_window != nullptr) DestroyWindow();
	glfwTerminate();
}

void Application::Setup()
{
	// Background color
	glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
	glEnable(GL_DEPTH_TEST);
	glDepthFunc(GL_LEQUAL);
	glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
	glEnable(GL_CULL_FACE);
}

void Application::Cleanup()
{
}

void Application::Run()
{
	PreCreate();

	// Create the GLFW window
	_window = glfwCreateWindow(_win_width, _win_height, _win_title, NULL, NULL);

	// Check if the window could not be created
	if (!_window)
	{
		std::cerr << "Failed to open GLFW window." << std::endl;
		std::cerr << "Either GLFW is not installed or your graphics card does not support modern OpenGL." << std::endl;
		glfwTerminate();
		return;
	}

	PostCreate();

	// Load GLAD
	if (!gladLoadGLLoader((GLADloadproc)glfwGetProcAddress))
	{
		std::cerr << "Failed to initialize GLAD" << std::endl;
		return;
	}

	Setup();

	glfwSwapInterval(1);
	glfwGetFramebufferSize(_window, &_win_width, &_win_height);
	StaticResize(_window, _win_width, _win_height);

	while (!glfwWindowShouldClose(_window))
	{
		float current_frame = glfwGetTime();
		_delta_time = current_frame - _last_frame;
		_last_frame = current_frame;

		glfwPollEvents();
		Update();
		Draw();
		glfwSwapBuffers(_window);
	}

	Cleanup();
}

void Application::Update()
{
}

void Application::Draw()
{
	// Begin drawing scene
	glViewport(0, 0, _win_width, _win_height);
	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

	// Finish drawing scene
	glFinish();
}

void Application::Reset()
{
}

void Application::StaticError(int error, const char* description)
{
	std::cerr << description << std::endl;
}

void Application::StaticResize(GLFWwindow* window, int x, int y)
{
	Application * instance = (Application *)glfwGetWindowUserPointer(window);
	instance->Resize(x, y);
}

void Application::StaticKeyboard(GLFWwindow* window,
	int key, int scancode, int action, int mods)
{
	Application * instance = (Application *)glfwGetWindowUserPointer(window);
	instance->Keyboard(key, scancode, action, mods);
}

void Application::StaticMouseButton(GLFWwindow* window, int btn, int action, int mods)
{
	Application * instance = (Application *)glfwGetWindowUserPointer(window);
	instance->MouseButton(btn, action, mods);
}

void Application::StaticMouseMotion(GLFWwindow* window, double x, double y)
{
	Application * instance = (Application *)glfwGetWindowUserPointer(window);
	instance->MouseMotion(x, y);
}

void Application::StaticMouseScroll(GLFWwindow* window, double x, double y)
{
	Application * instance = (Application *)glfwGetWindowUserPointer(window);
	instance->MouseScroll(x, y);
}

void Application::Resize(int x, int y)
{
	glfwGetFramebufferSize(_window, &x, &y);
	_win_width  = x;
	_win_height = y;
	glViewport(0, 0, x, y);
}

void Application::Keyboard(int key, int scancode, int action, int mods)
{
	if (action == GLFW_PRESS)
	{
		if (mods == GLFW_MOD_SHIFT)
		{
			
		}
		else
		{
			
		}
	}
	else if (action == GLFW_RELEASE)
	{
		if (mods == GLFW_MOD_SHIFT)
		{
			
		}
		else
		{
			
		}
	}
}

void Application::MouseButton(int btn, int action, int mods)
{
}

void Application::MouseMotion(double x, double y)
{
}

void Application::MouseScroll(double x, double y)
{
}

void Application::PreCreate()
{
	glfwWindowHint(GLFW_SAMPLES, 4);
	glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 4);
	glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 1);
	glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);
	glfwWindowHint(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);
}

void Application::PostCreate()
{
	glfwSetWindowUserPointer(_window, this); // Keep track of Application instance
	glfwSetKeyCallback(_window, StaticKeyboard);
	glfwSetMouseButtonCallback(_window, StaticMouseButton);
	glfwSetCursorPosCallback(_window, StaticMouseMotion);
	glfwSetScrollCallback(_window, StaticMouseScroll);
	glfwSetFramebufferSizeCallback(_window, StaticResize);
	glfwMakeContextCurrent(_window);
}

void Application::DestroyWindow()
{
	glfwSetKeyCallback(_window, nullptr);
	glfwSetMouseButtonCallback(_window, nullptr);
	glfwSetCursorPosCallback(_window, nullptr);
	glfwSetFramebufferSizeCallback(_window, nullptr);
	glfwDestroyWindow(_window);
}